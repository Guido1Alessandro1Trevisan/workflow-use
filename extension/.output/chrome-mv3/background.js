var background=function(){"use strict";var _,C;function U(t){return t==null||typeof t=="function"?{main:t}:t}var u=(t=>(t[t.DomContentLoaded=0]="DomContentLoaded",t[t.Load=1]="Load",t[t.FullSnapshot=2]="FullSnapshot",t[t.IncrementalSnapshot=3]="IncrementalSnapshot",t[t.Meta=4]="Meta",t[t.Custom=5]="Custom",t[t.Plugin=6]="Plugin",t))(u||{}),g=(t=>(t[t.Mutation=0]="Mutation",t[t.MouseMove=1]="MouseMove",t[t.MouseInteraction=2]="MouseInteraction",t[t.Scroll=3]="Scroll",t[t.ViewportResize=4]="ViewportResize",t[t.Input=5]="Input",t[t.TouchMove=6]="TouchMove",t[t.MediaInteraction=7]="MediaInteraction",t[t.StyleSheetRule=8]="StyleSheetRule",t[t.CanvasMutation=9]="CanvasMutation",t[t.Font=10]="Font",t[t.Log=11]="Log",t[t.Drag=12]="Drag",t[t.StyleDeclaration=13]="StyleDeclaration",t[t.Selection=14]="Selection",t[t.AdoptedStyleSheet=15]="AdoptedStyleSheet",t[t.CustomElement=16]="CustomElement",t))(g||{});const v=U(()=>{const t={},c={};let d=!0,E=null;const R="http://127.0.0.1:7331/event";async function k(o){const n=new TextEncoder().encode(o),r=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(r)).map(l=>l.toString(16).padStart(2,"0")).join("")}async function b(o){try{await fetch(R,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}catch(s){console.warn(`Failed to send event to Python server at ${R}:`,s)}}async function y(){const o=Object.keys(t).flatMap(a=>{const l=parseInt(a,10);return N(t[l]||[])}).sort((a,l)=>a.timestamp-l.timestamp),s={name:"Recorded Workflow",description:`Recorded on ${new Date().toLocaleString()}`,version:"1.0.0",input_schema:[],steps:o},n=JSON.stringify(o),r=await k(n);if(E!==null&&r===E)return s;E=r;const e={type:"WORKFLOW_UPDATE",timestamp:Date.now(),payload:s};return b(e),s}function O(){const o=d?"recording":"stopped";chrome.tabs.query({},s=>{s.forEach(n=>{n.id&&chrome.tabs.sendMessage(n.id,{type:"SET_RECORDING_STATUS",payload:d}).catch(r=>{})})}),chrome.runtime.sendMessage({type:"recording_status_updated",payload:{status:o}}).catch(s=>{})}function T(o,s){if(!d)return;console.log(`Sending ${o}:`,s);const n=s.tabId;n?(t[n]||(t[n]=[]),t[n].push({messageType:o,timestamp:Date.now(),tabId:n,...s}),y()):console.warn("Tab event received without tabId in payload:",o,s)}chrome.tabs.onCreated.addListener(o=>{T("CUSTOM_TAB_CREATED",{tabId:o.id,openerTabId:o.openerTabId,url:o.pendingUrl||o.url,windowId:o.windowId,index:o.index})}),chrome.tabs.onUpdated.addListener((o,s,n)=>{(s.url||s.status==="complete")&&T("CUSTOM_TAB_UPDATED",{tabId:o,changeInfo:s,windowId:n.windowId,url:n.url,title:n.title})}),chrome.tabs.onActivated.addListener(o=>{T("CUSTOM_TAB_ACTIVATED",{tabId:o.tabId,windowId:o.windowId})}),chrome.tabs.onRemoved.addListener((o,s)=>{T("CUSTOM_TAB_REMOVED",{tabId:o,windowId:s.windowId,isWindowClosing:s.isWindowClosing})});function N(o){var n;const s=[];for(const r of o)switch(r.messageType){case"CUSTOM_CLICK_EVENT":{const e=r;if(e.url&&e.frameUrl&&e.xpath&&e.elementTag){const a={type:"click",timestamp:e.timestamp,tabId:e.tabId,url:e.url,frameUrl:e.frameUrl,xpath:e.xpath,cssSelector:e.cssSelector,elementTag:e.elementTag,elementText:e.elementText,screenshot:e.screenshot};s.push(a)}else console.warn("Skipping incomplete CUSTOM_CLICK_EVENT:",e);break}case"CUSTOM_INPUT_EVENT":{const e=r;if(e.url&&e.xpath&&e.elementTag){const a=s.length>0?s[s.length-1]:null;if(a&&a.type==="input"&&a.tabId===e.tabId&&a.url===e.url&&a.frameUrl===e.frameUrl&&a.xpath===e.xpath&&a.cssSelector===e.cssSelector&&a.elementTag===e.elementTag)a.value=e.value,a.timestamp=e.timestamp,a.screenshot=e.screenshot;else{const l={type:"input",timestamp:e.timestamp,tabId:e.tabId,url:e.url,frameUrl:e.frameUrl,xpath:e.xpath,cssSelector:e.cssSelector,elementTag:e.elementTag,value:e.value,screenshot:e.screenshot};s.push(l)}}else console.warn("Skipping incomplete CUSTOM_INPUT_EVENT:",e);break}case"CUSTOM_KEY_EVENT":{const e=r;if(e.url&&e.key){const a={type:"key_press",timestamp:e.timestamp,tabId:e.tabId,url:e.url,frameUrl:e.frameUrl,key:e.key,xpath:e.xpath,cssSelector:e.cssSelector,elementTag:e.elementTag,screenshot:e.screenshot};s.push(a)}else console.warn("Skipping incomplete CUSTOM_KEY_EVENT:",e);break}case"RRWEB_EVENT":{const e=r;if(e.type===u.IncrementalSnapshot&&e.data.source===g.Scroll){const a=e.data,l=c[e.tabId],p=s.length>0?s[s.length-1]:null;if(p&&p.type==="scroll"&&p.tabId===e.tabId&&p.targetId===a.id)p.scrollX=a.x,p.scrollY=a.y,p.timestamp=e.timestamp;else{const i={type:"scroll",timestamp:e.timestamp,tabId:e.tabId,targetId:a.id,scrollX:a.x,scrollY:a.y,url:l==null?void 0:l.url};s.push(i)}}else if(e.type===u.Meta&&((n=e.data)!=null&&n.href)){const a=e.data,l={type:"navigation",timestamp:e.timestamp,tabId:e.tabId,url:a.href};s.push(l)}break}}return s}chrome.runtime.onMessage.addListener((o,s,n)=>{var a,l,p;let r=!1;const e=["CUSTOM_CLICK_EVENT","CUSTOM_INPUT_EVENT","CUSTOM_SELECT_EVENT","CUSTOM_KEY_EVENT"];if(o.type==="RRWEB_EVENT"||e.includes(o.type)){if(!d)return!1;if(!((a=s.tab)!=null&&a.id))return console.warn("Received event without tab ID:",o),!1;const i=s.tab.id,f=e.includes(o.type),m=(S,A)=>{var M,D;t[i]||(t[i]=[]),c[i]||(c[i]={}),(M=s.tab)!=null&&M.url&&!c[i].url&&(c[i].url=s.tab.url),(D=s.tab)!=null&&D.title&&!c[i].title&&(c[i].title=s.tab.title);const P={...S,tabId:i,messageType:o.type,screenshot:A};t[i].push(P),y()};f&&((l=s.tab)!=null&&l.windowId)?(r=!0,chrome.tabs.captureVisibleTab(s.tab.windowId,{format:"jpeg",quality:75},S=>{chrome.runtime.lastError?(console.error("Screenshot failed:",chrome.runtime.lastError.message),m(o.payload)):m(o.payload,S)})):o.type==="RRWEB_EVENT"?m(o.payload):f&&(console.warn("Storing custom event without screenshot due to missing windowId or other issue."),m(o.payload))}else{if(o.type==="GET_RECORDING_DATA")return r=!0,(async()=>{const i=await y(),f=d?"recording":i.steps.length>0?"stopped":"idle";n({workflow:i,recordingStatus:f})})(),r;if(o.type==="START_RECORDING"){if(console.log("Received START_RECORDING request."),Object.keys(t).forEach(i=>delete t[parseInt(i)]),Object.keys(c).forEach(i=>delete c[parseInt(i)]),console.log("Cleared previous recording data."),!d){d=!0,console.log("Recording status set to: true"),O();const i={type:"RECORDING_STARTED",timestamp:Date.now(),payload:{message:"Recording has started"}};b(i)}n({status:"started"})}else if(o.type==="STOP_RECORDING"){if(console.log("Received STOP_RECORDING request."),d){d=!1,console.log("Recording status set to: false"),O();const i={type:"RECORDING_STOPPED",timestamp:Date.now(),payload:{message:"Recording has stopped"}};b(i)}n({status:"stopped"})}else o.type==="REQUEST_RECORDING_STATUS"&&((p=s.tab)!=null&&p.id)&&(console.log(`Sending initial status (${d}) to tab ${s.tab.id}`),n({isRecordingEnabled:d}))}return r}),console.log("Background script loaded. Initial recording status:",d,"(EventType:",u,", IncrementalSource:",g,")"),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(o=>console.error("Failed to set panel behavior:",o))});function x(){}(C=(_=globalThis.browser)==null?void 0:_.runtime)!=null&&C.id?globalThis.browser:globalThis.chrome;function h(t,...c){}const I={debug:(...t)=>h(console.debug,...t),log:(...t)=>h(console.log,...t),warn:(...t)=>h(console.warn,...t),error:(...t)=>h(console.error,...t)};let w;try{w=v.main(),w instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw I.error("The background crashed on startup!"),t}return w}();
background;
